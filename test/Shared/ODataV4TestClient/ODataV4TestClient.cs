// Copyright (c) Microsoft. All rights reserved.
// Licensed under the MIT license. See LICENSE file in the project root for full license information.





//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

#pragma warning disable 109
using global::Microsoft.OData.Client;
using global::Microsoft.OData.Core;

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Reflection;

using global::Microsoft.OData.Core;
using ODataV4TestClient.Extensions;

namespace ODataV4TestClient.Extensions
{
    internal class LowerCasePropertyAttribute : System.Attribute
    {
    }

    public interface IEntityBase
    {
        global::System.Threading.Tasks.Task UpdateAsync(bool dontSave = false);
        global::System.Threading.Tasks.Task DeleteAsync(bool dontSave = false);
    }

    internal class RestShallowObjectFetcher : BaseEntityType
    {
        private string _path;
        internal new DataServiceContextWrapper Context
        {
            get
            {
                return (DataServiceContextWrapper)base.Context;
            }
            private set
            {
                base.Context = value;
            }
        }

        internal RestShallowObjectFetcher() { }

        internal void Initialize(
            DataServiceContextWrapper context,
            string path)
        {
            Context = context;
            _path = path;
        }

        protected string GetPath(string propertyName)
        {
            return propertyName == null ? _path : _path + "/" + propertyName;
        }

        protected System.Uri GetUrl()
        {
            return new Uri(Context.BaseUri.ToString().TrimEnd('/') + "/" + GetPath(null));
        }
    }

    public partial class DataServiceContextWrapper : DataServiceContext
    {
        private object _syncLock = new object();
        private string _accessToken;
        private global::System.Func<global::System.Threading.Tasks.Task<string>> _accessTokenGetter;
        private System.Func<System.Threading.Tasks.Task> _accessTokenSetter;
        private HashSet<EntityBase> _modifiedEntities = new HashSet<EntityBase>();

        public void UpdateObject(EntityBase entity)
        {
            if (GetEntityDescriptor(entity) != null)
            {
                _modifiedEntities.Add(entity);
                base.UpdateObject(entity);
            }
        }

        private async global::System.Threading.Tasks.Task SetToken()
        {
            var token = await _accessTokenGetter();
            lock (_syncLock)
            {
                _accessToken = token;
            }
        }

        public DataServiceContextWrapper(Uri serviceRoot, global::Microsoft.OData.Client.ODataProtocolVersion maxProtocolVersion, global::System.Func<global::System.Threading.Tasks.Task<string>> accessTokenGetter)
        : base(serviceRoot, maxProtocolVersion)
        {
            _accessTokenGetter = accessTokenGetter;
            _accessTokenSetter = SetToken;

            IgnoreMissingProperties = true;

            BuildingRequest += (s, args) =>
            {
                args.Headers.Add("Authorization", "Bearer " + _accessToken);
                args.Headers.Add("X-ClientService-ClientTag", string.Format("Office 365 API Tools {0}", "1.1.0612"));
            };

            Configurations.RequestPipeline.OnEntryStarting(new Action<WritingEntryArgs>(e2 =>
            {
                var entity = (EntityBase)e2.Entity;

                if (!entity.ChangedProperties.IsValueCreated || entity.ChangedProperties.Value.Count == 0)
                {
                    e2.Entry.Properties = new ODataProperty[0];
                    return;
                }

                if (!_modifiedEntities.Contains(entity))
                {
                    _modifiedEntities.Add(entity);
                }

                var properties = e2.Entry.Properties.Where(i => entity.ChangedProperties.Value.Contains(i.Name)).ToArray();
                e2.Entry.Properties = properties;
            }));

            Configurations.ResponsePipeline.OnEntityMaterialized(new Action<MaterializedEntityArgs>(e2 =>
            {
                var entity = (EntityBase)e2.Entity;

                entity.ResetChanges();
            }));

            OnCreated();
        }

        partial void OnCreated();


        internal System.Type DefaultResolveTypeInternal(string typeName, string fullNamespace, string languageDependentNamespace)
        {
            return DefaultResolveType(typeName, fullNamespace, languageDependentNamespace);
        }

        public async System.Threading.Tasks.Task<TInterface> ExecuteSingleAsync<TSource, TInterface>(DataServiceQuery<TSource> inner)
        {
            try
            {
                await SetToken();
                return await global::System.Threading.Tasks.Task.Factory.FromAsync<TInterface>(
                    inner.BeginExecute,
                    new global::System.Func<global::System.IAsyncResult, TInterface>(i =>
                        global::System.Linq.Enumerable.SingleOrDefault(
                        global::System.Linq.Enumerable.Cast<TInterface>(inner.EndExecute(i)))),
                    global::System.Threading.Tasks.TaskCreationOptions.None);
            }
            catch (Exception ex)
            {
                var newException = ProcessException(ex);

                if (newException != null)
                {
                    throw newException;
                }

                throw;
            }
        }

        public async System.Threading.Tasks.Task<IBatchElementResult[]> ExecuteBatchAsync(params IReadOnlyQueryableSetBase[] queries)
        {
            try
            {
                var requests = (from i in queries select (DataServiceRequest)i.Query).ToArray();

                await SetToken();

                var responses = await global::System.Threading.Tasks.Task.Factory.FromAsync<DataServiceRequest[], DataServiceResponse>(
                    (q, callback, state) => BeginExecuteBatch(callback, state, q), // need to reorder parameters
                    EndExecuteBatch,
                    requests,
                    null);

                var retVal = new IBatchElementResult[queries.Length];

                var index = 0;
                foreach (var response in responses)
                {
                    Type tConcrete = ((IConcreteTypeAccessor)queries[index]).ConcreteType;
                    Type tInterface = ((IConcreteTypeAccessor)queries[index]).ElementType;

                    var pcType = typeof(PagedCollection<,>).MakeGenericType(tInterface, tConcrete);
                    var pcTypeInfo = pcType.GetTypeInfo();
                    var PCCreator = pcTypeInfo.GetDeclaredMethod("Create");

                    // Handle an error response. 
                    // from http://msdn.microsoft.com/en-us/library/dd744838(v=vs.110).aspx
                    if (response.StatusCode > 299 || response.StatusCode < 200)
                    {
                        retVal[index] = new BatchElementResult(ProcessException(response.Error) ?? response.Error);
                    }
                    else
                    {
                        retVal[index] = new BatchElementResult((IPagedCollection)PCCreator.Invoke(null, new object[] { this, response }));
                    }

                    index++;
                }

                return retVal;
            }
            catch (Exception ex)
            {
                var newException = ProcessException(ex);

                if (newException != null)
                {
                    throw newException;
                }

                throw;
            }
        }

        public async System.Threading.Tasks.Task<System.IO.Stream> GetStreamAsync(Uri requestUriTmp)
        {
            using (var client = new System.Net.Http.HttpClient())
            {
                using (var request = new System.Net.Http.HttpRequestMessage(System.Net.Http.HttpMethod.Get, requestUriTmp))
                {
                    request.Headers.Add("Authorization", "Bearer " + await _accessTokenGetter());
                    request.Headers.Add("Accept", "*/*");
                    request.Headers.Add("Accept-Charset", "UTF-8");
                    request.Headers.Add("X-ClientService-ClientTag", "Office 365 API Tools, 1.1.0512");

                    // Do not dispose the response. If disposed, it will also dispose the
                    // stream we are returning
                    var response = await client.SendAsync(request);
                    if (response.IsSuccessStatusCode)
                    {
                        return await response.Content.ReadAsStreamAsync();
                    }

                    var newException = await ProcessErrorAsync(response);

                    if (newException != null)
                    {
                        throw newException;
                    }

                    response.EnsureSuccessStatusCode();

                    // unreachable
                    return null;
                }
            }
        }

        public async System.Threading.Tasks.Task<DataServiceStreamResponse> GetReadStreamAsync(EntityBase entity, string streamName, string contentType)
        {
            try
            {
                await SetToken();

                if (!string.IsNullOrEmpty(streamName))
                {
                    var resp = await global::System.Threading.Tasks.Task.Factory.FromAsync<object, string, DataServiceRequestArgs, DataServiceStreamResponse>(
                        BeginGetReadStream,
                        EndGetReadStream,
                        entity,
                        streamName,
                        new DataServiceRequestArgs { ContentType = contentType /*, Headers = {todo}*/ },
                        null);
                    return resp;
                }
                else
                {
                    var resp = await global::System.Threading.Tasks.Task.Factory.FromAsync<object, DataServiceRequestArgs, DataServiceStreamResponse>(
                        BeginGetReadStream,
                        EndGetReadStream,
                        entity,
                        new DataServiceRequestArgs { ContentType = contentType /*, Headers = {todo}*/ },
                        null);

                    return resp;
                }
            }
            catch (Exception ex)
            {
                var newException = ProcessException(ex);

                if (newException != null)
                {
                    throw newException;
                }

                throw;
            }
        }

        public async System.Threading.Tasks.Task<IPagedCollection<TInterface>> ExecuteAsync<TSource, TInterface>(DataServiceQuery<TSource> inner) where TSource : TInterface
        {
            try
            {
                await SetToken();
                return await global::System.Threading.Tasks.Task.Factory.FromAsync<
                            IPagedCollection<TInterface>>(inner.BeginExecute,
                            new global::System.Func<global::System.IAsyncResult, IPagedCollection<TInterface>>(
                                r =>
                                {
                                    var innerResult = (QueryOperationResponse<TSource>)inner.EndExecute(r);


                                    return new PagedCollection<TInterface, TSource>(this, innerResult);
                                }
                                ), global::System.Threading.Tasks.TaskCreationOptions.None);
            }
            catch (Exception ex)
            {
                var newException = ProcessException(ex);

                if (newException != null)
                {
                    throw newException;
                }

                throw;
            }
        }

        public new global::System.Threading.Tasks.Task<global::System.Collections.Generic.IEnumerable<T>> ExecuteAsync<T>(
            global::System.Uri uri,
            string httpMethod,
            bool singleResult,
            params OperationParameter[] operationParameters)
        {
            return ExecuteAsyncInternal<T>(uri, httpMethod, singleResult, (System.IO.Stream)null, operationParameters);
        }

        public global::System.Threading.Tasks.Task<global::System.Collections.Generic.IEnumerable<T>> ExecuteAsync<T>(
            global::System.Uri uri,
            string httpMethod,
            bool singleResult,
            System.IO.Stream stream,
            params OperationParameter[] operationParameters)
        {
            return ExecuteAsyncInternal<T>(uri, httpMethod, singleResult, stream ?? new System.IO.MemoryStream(), operationParameters);
        }

        public async global::System.Threading.Tasks.Task<global::System.Collections.Generic.IEnumerable<T>> ExecuteAsyncInternal<T>(
            global::System.Uri uri,
            string httpMethod,
            bool singleResult,
            System.IO.Stream stream,
            params OperationParameter[] operationParameters)
        {
            try
            {
                await SetToken();

                if (stream != null)
                {
                    Configurations.RequestPipeline.OnMessageCreating = (global::Microsoft.OData.Client.DataServiceClientRequestMessageArgs args) =>
                    {
                        args.Headers.Remove("Content-Length");

                        var msg = new global::Microsoft.OData.Client.HttpWebRequestMessage(args);

                        global::System.Threading.Tasks.Task.Factory.FromAsync<System.IO.Stream>(msg.BeginGetRequestStream, msg.EndGetRequestStream, null).ContinueWith
                            (s => stream.CopyTo(s.Result))
                            .Wait();

                        return msg;
                    };
                }

                return await global::System.Threading.Tasks.Task.Factory.FromAsync<global::System.Collections.Generic.IEnumerable<T>>
                (
                    (callback, state) => BeginExecute<T>(uri, callback, state, httpMethod, singleResult, operationParameters),
                    EndExecute<T>, global::System.Threading.Tasks.TaskCreationOptions.None);
            }
            catch (Exception ex)
            {
                var newException = ProcessException(ex);

                if (newException != null)
                {
                    throw newException;
                }

                throw;
            }
            finally
            {
                if (stream != null)
                {
                    Configurations.RequestPipeline.OnMessageCreating = null;
                }
            }
        }

        public new global::System.Threading.Tasks.Task ExecuteAsync(
            global::System.Uri uri,
            string httpMethod,
            params OperationParameter[] operationParameters)
        {
            return ExecuteAsync(uri, httpMethod, (System.IO.Stream)null, operationParameters);
        }

        public async global::System.Threading.Tasks.Task ExecuteAsync(
            global::System.Uri uri,
            string httpMethod,
            System.IO.Stream stream,
            params OperationParameter[] operationParameters
            )
        {
            try
            {
                await SetToken();
                if (stream != null)
                {
                    Configurations.RequestPipeline.OnMessageCreating = (global::Microsoft.OData.Client.DataServiceClientRequestMessageArgs args) =>
                    {
                        args.Headers.Remove("Content-Length");

                        var msg = new global::Microsoft.OData.Client.HttpWebRequestMessage(args);

                        global::System.Threading.Tasks.Task.Factory.FromAsync<System.IO.Stream>(msg.BeginGetRequestStream, msg.EndGetRequestStream, null).ContinueWith
                            (s => stream.CopyTo(s.Result))
                            .Wait();

                        return msg;
                    };
                }

                await global::System.Threading.Tasks.Task.Factory.FromAsync
                        (
                            new global::System.Func<global::System.AsyncCallback, object, global::System.IAsyncResult>(
                                (callback, state) => BeginExecute(uri, callback, state, httpMethod, operationParameters)),
                            new global::System.Action<global::System.IAsyncResult>((i) => EndExecute(i)),
                            global::System.Threading.Tasks.TaskCreationOptions.None);
            }
            catch (Exception ex)
            {
                var newException = ProcessException(ex);

                if (newException != null)
                {
                    throw newException;
                }

                throw;
            }
            finally
            {
                if (stream != null)
                {
                    Configurations.RequestPipeline.OnMessageCreating = null;
                }
            }
        }

        public async System.Threading.Tasks.Task<QueryOperationResponse<TSource>> ExecuteAsync<TSource, TInterface>(DataServiceQueryContinuation<TSource> token)
        {
            try
            {
                await SetToken();

                return await global::System.Threading.Tasks.Task.Factory.FromAsync<QueryOperationResponse<TSource>>(
                    (callback, state) => BeginExecute(token, callback, state),
                    (i) => (QueryOperationResponse<TSource>)EndExecute<TSource>(i),
                    global::System.Threading.Tasks.TaskCreationOptions.None);
            }
            catch (Exception ex)
            {
                var newException = ProcessException(ex);

                if (newException != null)
                {
                    throw newException;
                }

                throw;
            }
        }

        public async new System.Threading.Tasks.Task<DataServiceResponse> SaveChangesAsync(SaveChangesOptions options)
        {
            try
            {
                await SetToken();
                var result = await global::System.Threading.Tasks.Task.Factory.FromAsync<SaveChangesOptions, DataServiceResponse>(
                    BeginSaveChanges,
                    new global::System.Func<global::System.IAsyncResult, DataServiceResponse>(EndSaveChanges),
                    options,
                    null,
                    global::System.Threading.Tasks.TaskCreationOptions.None);

                foreach (var i in _modifiedEntities)
                {
                    i.ResetChanges();
                }

                _modifiedEntities.Clear();
                return result;
            }
            catch (Exception ex)
            {
                var newException = ProcessException(ex);

                if (newException != null)
                {
                    throw newException;
                }

                throw;
            }
        }

        public new System.Threading.Tasks.Task<DataServiceResponse> SaveChangesAsync()
        {
            return SaveChangesAsync(SaveChangesOptions.None);
        }

#if NOTYET
        public async System.Threading.Tasks.Task<IPagedCollection<TSource>> LoadPropertyAsync<TSource>(string path, object entity)
        {
            try
            {
                await SetToken();
                return await global::System.Threading.Tasks.Task.Factory.FromAsync<
                    IPagedCollection<TSource>>(
                    (AsyncCallback callback, object state) =>
                    {
                        return BeginLoadProperty(entity, path, callback, state);
                    },
                    new global::System.Func<global::System.IAsyncResult, IPagedCollection<TSource>>(
                        r =>
                        {
                            var innerResult = (QueryOperationResponse<TSource>)EndLoadProperty(r);

                            return new PagedCollection<TSource>(this, innerResult);
                        }
                        ), global::System.Threading.Tasks.TaskCreationOptions.None);
            }
            catch (Exception ex)
            {
                var newException = ProcessException(ex);

                if (newException != null)
                {
                    throw newException;
                }

                throw;
            }
        }
#endif

        internal static Exception ProcessException(Exception ex)
        {
            if (ex is DataServiceRequestException)
            {
                var response = ((DataServiceRequestException)ex).Response.FirstOrDefault();

                if (response != null)
                {
                    return ProcessError((DataServiceRequestException)ex, ex.InnerException as DataServiceClientException, response.Headers);
                }
            }

            if (ex is DataServiceQueryException)
            {
                return ProcessError((DataServiceQueryException)ex, ex.InnerException as DataServiceClientException, ((DataServiceQueryException)ex).Response.Headers);
            }

            if (ex is DataServiceClientException)
            {
                return ProcessError(ex, (DataServiceClientException)ex, new Dictionary<string, string> { { "Content-Type", ex.Message.StartsWith("<") ? "application/xml" : "application/json" } });
            }

            return null;
        }


        private static Exception ProcessError(Exception outer, DataServiceClientException inner, IDictionary<string, string> headers)
        {
            if (inner == null)
            {
                return null;
            }

            using (var writer = WriteToStream(inner.Message))
            {
                var httpMessage = new HttpWebResponseMessage(
                    headers,
                inner.StatusCode,
                () => writer.BaseStream);

                var reader = new ODataMessageReader(httpMessage);

                try
                {
                    var error = reader.ReadError();
                    return new ODataErrorException(error.Message, outer, error);
                }
                catch
                {
                }
            }

            return null;
        }

        private static async System.Threading.Tasks.Task<Exception> ProcessErrorAsync(System.Net.Http.HttpResponseMessage response)
        {
            if (response.Content == null)
            {
                return null;
            }

            if (response.Content.Headers.ContentType == null)
            {
                return new System.Net.Http.HttpRequestException(await response.Content.ReadAsStringAsync());
            }

            using (var stream = await response.Content.ReadAsStreamAsync())
            {
                var headers = Enumerable.ToDictionary(response.Content.Headers, i => i.Key, i => i.Value.FirstOrDefault());

                var httpMessage = new HttpWebResponseMessage(
                  headers,
                (int)response.StatusCode,
                () => stream);

                var reader = new ODataMessageReader(httpMessage);

                try
                {
                    var error = reader.ReadError();
                    return new ODataErrorException(error.Message, null, error);
                }
                catch
                {
                }
            }

            return null;
        }

        private static System.IO.StreamWriter WriteToStream(string contents)
        {
            var stream = new System.IO.MemoryStream();
            var writer = new System.IO.StreamWriter(stream);
            writer.Write(contents);
            writer.Flush();
            stream.Seek(0, System.IO.SeekOrigin.Begin);
            return writer;
        }
    }

    public interface IBatchElementResult
    {
        IPagedCollection SuccessResult { get; }
        Exception FailureResult { get; }
    }

    internal class BatchElementResult : IBatchElementResult
    {
        public BatchElementResult(IPagedCollection successResult)
        {
            SuccessResult = successResult;
        }

        public BatchElementResult(Exception failureResult)
        {
            FailureResult = failureResult;
        }

        public IPagedCollection SuccessResult
        {
            get;
            private set;
        }

        public Exception FailureResult
        {
            get;
            private set;
        }
    }

    public class ComplexTypeBase
    {
        private Func<Tuple<EntityBase, string>> _entity;

        protected ComplexTypeBase()
        {
        }

        internal virtual void SetContainer(Func<Tuple<EntityBase, string>> entity)
        {
            _entity = entity;
        }

        protected Tuple<EntityBase, string> GetContainingEntity(string propertyName)
        {
            return _entity != null ? _entity() : null;
        }

        protected void OnPropertyChanged(string propertyName)
        {
            var tuple = GetContainingEntity(propertyName);

            if (tuple != null)
            {
                tuple.Item1.OnPropertyChanged(tuple.Item2);
            }
        }
    }

    internal class EntityCollectionImpl<T> : DataServiceCollection<T> where T : EntityBase
    {
        private Func<Tuple<EntityBase, string>> _entity;

        public EntityCollectionImpl()
            : base(null, TrackingMode.None)
        {
        }

        internal void SetContainer(Func<Tuple<EntityBase, string>> entity)
        {
            _entity = entity;
        }

        protected override void InsertItem(int index, T item)
        {
            InvokeOnEntity(tuple => tuple.Item1.Context.AddRelatedObject(tuple.Item1, tuple.Item2, item));

            base.InsertItem(index, item);
        }

        protected override void ClearItems()
        {
            InvokeOnEntity(tuple =>
            {
                foreach (var i in this)
                {
                    tuple.Item1.Context.DeleteLink(tuple.Item1, tuple.Item2, i);
                }
            });

            base.ClearItems();
        }

        protected override void RemoveItem(int index)
        {
            InvokeOnEntity(tuple => tuple.Item1.Context.DeleteLink(tuple.Item1, tuple.Item2, this[index]));

            base.RemoveItem(index);
        }

        protected override void SetItem(int index, T item)
        {
            InvokeOnEntity(tuple =>
                    {
                        tuple.Item1.Context.DeleteLink(tuple.Item1, tuple.Item2, this[index]);
                        tuple.Item1.Context.AddRelatedObject(tuple.Item1, tuple.Item2, item);
                    }
            );

            base.SetItem(index, item);
        }

        private void InvokeOnEntity(Action<Tuple<EntityBase, string>> action)
        {
            if (_entity != null)
            {
                var tuple = _entity();

                if (tuple.Item1.Context != null && tuple.Item1.Context.GetEntityDescriptor(tuple.Item1) != null)
                {
                    action(tuple);
                }
            }
        }
    }

    internal class NonEntityTypeCollectionImpl<T> : global::System.Collections.ObjectModel.Collection<T>
    {
        private Func<Tuple<EntityBase, string>> _entity;

        private static readonly bool s_isComplexType = System.Reflection.IntrospectionExtensions.GetTypeInfo(typeof(T)).IsSubclassOf(typeof(ComplexTypeBase));

        public NonEntityTypeCollectionImpl()
            : base()
        {
        }

        internal void SetContainer(Func<Tuple<EntityBase, string>> entity)
        {
            _entity = entity;

            if (s_isComplexType)
            {
                foreach (var i in this)
                {
                    (i as ComplexTypeBase).SetContainer(entity);
                }
            }
        }

        protected override void InsertItem(int index, T item)
        {
            var ct = item as ComplexTypeBase;
            if (ct != null)
            {
                ct.SetContainer(_entity);
            }

            base.InsertItem(index, item);

            InvokeOnPropertyChanged();
        }

        protected override void ClearItems()
        {
            base.ClearItems();
            InvokeOnPropertyChanged();
        }

        protected override void RemoveItem(int index)
        {
            base.RemoveItem(index);
            InvokeOnPropertyChanged();
        }

        protected override void SetItem(int index, T item)
        {
            var ct = item as ComplexTypeBase;
            if (ct != null)
            {
                ct.SetContainer(_entity);
            }
            base.SetItem(index, item);
            InvokeOnPropertyChanged();
        }

        private void InvokeOnPropertyChanged()
        {
            var tuple = _entity != null ? _entity() : null;
            if (tuple != null)
            {
                tuple.Item1.OnPropertyChanged(tuple.Item2);
            }
        }
    }

    public class EntityBase : BaseEntityType
    {
        private Lazy<HashSet<string>> _changedProperties = new Lazy<HashSet<string>>(true);

        internal Lazy<HashSet<string>> ChangedProperties
        {
            get { return _changedProperties; }
        }

        protected Tuple<EntityBase, string> GetContainingEntity(string propertyName)
        {
            return new Tuple<EntityBase, string>(this, propertyName);
        }

        internal void OnPropertyChanged([global::System.Runtime.CompilerServices.CallerMemberName] string propertyName = null)
        {
            _changedProperties.Value.Add(propertyName);
            if (Context != null)
            {
                Context.UpdateObject(this);
            }
        }

        internal void ResetChanges()
        {
            _changedProperties = new Lazy<HashSet<string>>(true);
        }

        internal new DataServiceContextWrapper Context
        {
            get
            {
                return (DataServiceContextWrapper)base.Context;
            }
            private set
            {
                base.Context = value;
            }
        }

        internal void Initialize(
            )
        {
        }

        protected string GetPath(string propertyName)
        {
            Uri uri = GetUrl();
            if (uri != null)
            {
                return uri.ToString().Substring(Context.BaseUri.ToString().Length + 1) + "/" + propertyName;
            }

            return null;
        }

        protected System.Uri GetUrl()
        {
            if (Context == null)
            {
                return null;
            }

            Uri uri;
            Context.TryGetUri(this, out uri);

            return uri;
        }

        public global::System.Threading.Tasks.Task UpdateAsync(bool dontSave = false)
        {
            Context.UpdateObject(this);
            return SaveAsNeeded(dontSave);
        }

        public global::System.Threading.Tasks.Task DeleteAsync(bool dontSave = false)
        {
            Context.DeleteObject(this);
            return SaveAsNeeded(dontSave);
        }

        protected internal global::System.Threading.Tasks.Task SaveAsNeeded(bool dontSave)
        {
            if (!dontSave)
            {
                return Context.SaveChangesAsync();
            }
            else
            {
                var retVal = new global::System.Threading.Tasks.TaskCompletionSource<object>();
                retVal.SetResult(null);
                return retVal.Task;
            }
        }
    }

    public class QueryableSet<TSource> : ReadOnlyQueryableSetBase<TSource>
    {
        protected string _path;
        protected object _entity;

        internal void SetContainer(Func<EntityBase> entity, string property)
        {
            // Unneeded
        }

        protected System.Uri GetUrl()
        {
            return new Uri(Context.BaseUri.ToString().TrimEnd('/') + "/" + _path);
        }

        internal QueryableSet(
            DataServiceQuery inner,
            DataServiceContextWrapper context,
            EntityBase entity,
            string path)
            : base(inner, context)
        {
            Initialize(inner, context, entity, path);
        }

        internal void Initialize(DataServiceQuery inner,
            DataServiceContextWrapper context,
            EntityBase entity,
            string path)
        {
            base.Initialize(inner, context);
            _path = path;
            _entity = entity;
        }
    }

    public interface IReadOnlyQueryableSet<TSource> : IReadOnlyQueryableSetBase<TSource>
    {
        System.Threading.Tasks.Task<IPagedCollection<TSource>> ExecuteAsync();
        System.Threading.Tasks.Task<TSource> ExecuteSingleAsync();
    }

    public class ReadOnlyQueryableSet<TSource> : ReadOnlyQueryableSetBase<TSource>, IReadOnlyQueryableSet<TSource>
    {
        internal ReadOnlyQueryableSet(
            DataServiceQuery inner,
            DataServiceContextWrapper context)
            : base(inner, context)
        {
        }


        public global::System.Threading.Tasks.Task<IPagedCollection<TSource>> ExecuteAsync()
        {
            return base.ExecuteAsyncInternal();
        }

        public global::System.Threading.Tasks.Task<TSource> ExecuteSingleAsync()
        {
            return base.ExecuteSingleAsyncInternal();
        }
    }

    public interface IReadOnlyQueryableSetBase
    {
        DataServiceContextWrapper Context { get; }
        DataServiceQuery Query { get; }
    }

    public interface IReadOnlyQueryableSetBase<TSource> : IReadOnlyQueryableSetBase
    {
        IReadOnlyQueryableSet<TSource> Expand<TTarget>(System.Linq.Expressions.Expression<Func<TSource, TTarget>> navigationPropertyAccessor);
        IReadOnlyQueryableSet<TResult> OfType<TResult>();
        IReadOnlyQueryableSet<TSource> OrderBy<TKey>(System.Linq.Expressions.Expression<Func<TSource, TKey>> keySelector);
        IReadOnlyQueryableSet<TSource> OrderByDescending<TKey>(System.Linq.Expressions.Expression<Func<TSource, TKey>> keySelector);
        IReadOnlyQueryableSet<TResult> Select<TResult>(System.Linq.Expressions.Expression<Func<TSource, TResult>> selector);
        IReadOnlyQueryableSet<TSource> Skip(int count);
        IReadOnlyQueryableSet<TSource> Take(int count);
        IReadOnlyQueryableSet<TSource> Where(System.Linq.Expressions.Expression<Func<TSource, bool>> predicate);
    }

    public interface IConcreteTypeAccessor
    {
        Type ConcreteType { get; }
        Type ElementType { get; }
    }

    public abstract class ReadOnlyQueryableSetBase<TSource> : IReadOnlyQueryableSetBase<TSource>, IConcreteTypeAccessor
    {
        protected DataServiceQuery _inner;
        protected DataServiceContextWrapper _context;

        private Lazy<Type> _concreteType = new Lazy<Type>(() => CreateConcreteType(typeof(TSource)), true);

        // Will return null if not an interface
        private static Type CreateConcreteType(Type tsourceType)
        {
            var tsourceTypeInfo = System.Reflection.IntrospectionExtensions.GetTypeInfo(tsourceType);
            if (tsourceTypeInfo.IsGenericType)
            {
                var arguments = tsourceTypeInfo.GenericTypeArguments;
                bool modified = false;

                for (int i = 0; i < arguments.Length; i++)
                {
                    var converted = CreateConcreteType(arguments[i]);
                    if (converted != null)
                    {
                        arguments[i] = converted;
                        modified = true;
                    }
                }

                if (!modified)
                {
                    return null;
                }

                // Properties declared as IPagedCollection on the interface are declared as IList on the concrete type
                if (tsourceTypeInfo.GetGenericTypeDefinition() == typeof(IPagedCollection<>))
                {
                    return typeof(IList<>).MakeGenericType(arguments);
                }

                return tsourceTypeInfo.GetGenericTypeDefinition().MakeGenericType(arguments);
            }

            const string Fetcher = "Fetcher";
            if (System.Linq.Enumerable.Any<System.Reflection.CustomAttributeData>(
                tsourceTypeInfo.CustomAttributes,
                i => i.AttributeType == typeof(LowerCasePropertyAttribute)))
            {
                string typeName = tsourceTypeInfo.Namespace + "." + tsourceTypeInfo.Name.Substring(1);
                if (typeName.EndsWith(Fetcher))
                {
                    typeName = typeName.Substring(typeName.Length - Fetcher.Length);
                }
                return tsourceTypeInfo.Assembly.GetType(typeName);
            }
            else
            {
                return null;
            }
        }

        public DataServiceContextWrapper Context
        {
            get { return _context; }
        }

        public DataServiceQuery Query
        {
            get { return _inner; }
        }

        public ReadOnlyQueryableSetBase(
            DataServiceQuery inner,
            DataServiceContextWrapper context)
        {
            Initialize(inner, context);
        }

        protected void Initialize(DataServiceQuery inner,
            DataServiceContextWrapper context)
        {
            _inner = inner;
            _context = context;
        }

        #region IConcreteTypeAccessor implementation

        Type IConcreteTypeAccessor.ConcreteType
        {
            get
            {
                return _concreteType.Value ?? typeof(TSource);
            }
        }

        Type IConcreteTypeAccessor.ElementType
        {
            get
            {
                return typeof(TSource);
            }
        }

        #endregion

        protected global::System.Threading.Tasks.Task<IPagedCollection<TSource>> ExecuteAsyncInternal()
        {
            if (_concreteType.Value != null)
            {
                var contextTypeInfo = System.Reflection.IntrospectionExtensions.GetTypeInfo(typeof(DataServiceContextWrapper));

                var executeAsyncMethodInfo =
                    (from i in contextTypeInfo.GetDeclaredMethods("ExecuteAsync")
                     let parameters = i.GetParameters()
                     where parameters.Length == 1 && parameters[0].ParameterType.GetGenericTypeDefinition() == typeof(DataServiceQuery<>)
                     select i).First();

                return (global::System.Threading.Tasks.Task<IPagedCollection<TSource>>)
                    executeAsyncMethodInfo.MakeGenericMethod(_concreteType.Value, typeof(TSource)).Invoke(_context, new[] { _inner });
            }
            else
            {
                return _context.ExecuteAsync<TSource, TSource>((DataServiceQuery<TSource>)_inner);
            }
        }

        protected global::System.Threading.Tasks.Task<TSource> ExecuteSingleAsyncInternal()
        {
            if (_concreteType.Value != null)
            {
                var contextTypeInfo = System.Reflection.IntrospectionExtensions.GetTypeInfo(typeof(DataServiceContextWrapper));

                var executeAsyncMethodInfo =
                    (from i in contextTypeInfo.GetDeclaredMethods("ExecuteSingleAsync")
                     let parameters = i.GetParameters()
                     where parameters.Length == 1 && parameters[0].ParameterType.GetGenericTypeDefinition() == typeof(DataServiceQuery<>)
                     select i).First();

                return (global::System.Threading.Tasks.Task<TSource>)
                    executeAsyncMethodInfo.MakeGenericMethod(_concreteType.Value, typeof(TSource)).Invoke(_context, new[] { _inner });
            }
            else
            {
                return _context.ExecuteSingleAsync<TSource, TSource>((DataServiceQuery<TSource>)_inner);
            }
        }

        #region LINQ


        private class PascalCaseExpressionVisitor : System.Linq.Expressions.ExpressionVisitor
        {
            private Dictionary<System.Linq.Expressions.ParameterExpression, System.Linq.Expressions.ParameterExpression>
                _parameterDictionary = new Dictionary<System.Linq.Expressions.ParameterExpression, System.Linq.Expressions.ParameterExpression>();

            protected override System.Linq.Expressions.Expression VisitExtension(System.Linq.Expressions.Expression node)
            {
                return node;
            }

            protected override System.Linq.Expressions.Expression VisitLambda<T>(System.Linq.Expressions.Expression<T> node)
            {
                var originalDelegateType = typeof(T);

                if (originalDelegateType.GetGenericTypeDefinition() == typeof(Func<,>))
                {
                    var newParameterArray = System.Reflection.IntrospectionExtensions.GetTypeInfo(originalDelegateType).GenericTypeArguments;
                    bool hasInterfaces = false;

                    var ct = CreateConcreteType(newParameterArray[0]);
                    if (ct != null)
                    {
                        hasInterfaces = true;
                        newParameterArray[0] = ct;
                    }

                    ct = CreateConcreteType(newParameterArray[1]);
                    if (ct != null)
                    {
                        hasInterfaces = true;
                        newParameterArray[1] = ct;
                    }

                    if (!hasInterfaces)
                    {
                        return base.VisitLambda(node);
                    }

                    var newdDelegateType = typeof(Func<,>).MakeGenericType(newParameterArray);

                    var invocationParameters = node.Parameters.ToArray();

                    for (int i = 0; i < invocationParameters.Length; i++)
                    {
                        var concreteType = CreateConcreteType(invocationParameters[i].Type);

                        if (concreteType != null)
                        {
                            if (!_parameterDictionary.ContainsKey(invocationParameters[i]))
                            {
                                _parameterDictionary[invocationParameters[i]] = System.Linq.Expressions.Expression.Parameter(
                                concreteType, invocationParameters[i].Name);
                            }

                            invocationParameters[i] = _parameterDictionary[invocationParameters[i]];
                        }
                    }

                    var body = Visit(node.Body);

                    var newLambda = System.Linq.Expressions.Expression.Lambda(
                        newdDelegateType,
                        body,
                        node.TailCall,
                        invocationParameters);

                    return newLambda;
                }

                return base.VisitLambda<T>(node);
            }

            protected override System.Linq.Expressions.Expression VisitParameter(System.Linq.Expressions.ParameterExpression node)
            {
                var concreteType = CreateConcreteType(node.Type);

                if (concreteType == null)
                {
                    return base.VisitParameter(node);
                }

                if (!_parameterDictionary.ContainsKey(node))
                {
                    _parameterDictionary[node] = System.Linq.Expressions.Expression.Parameter(
                    concreteType,
                    node.Name);
                }

                return base.VisitParameter(_parameterDictionary[node]);
            }

            protected override System.Linq.Expressions.Expression VisitMember(System.Linq.Expressions.MemberExpression node)
            {
                if (node.Member is System.Reflection.PropertyInfo)
                {
                    var interfaceType = CreateConcreteType(node.Type) != null;

                    var toLower = System.Linq.Enumerable.Any(
                        node.Member.CustomAttributes, i => i.AttributeType == typeof(LowerCasePropertyAttribute));

                    if (interfaceType || toLower)
                    {
                        var newExpression = Visit(node.Expression);

                        return base.VisitMember(
                            System.Linq.Expressions.Expression.Property(
                                newExpression,
                                System.Reflection.RuntimeReflectionExtensions.GetRuntimeProperty(
                                    newExpression.Type,
                                    toLower ? char.ToLower(node.Member.Name[0]) + node.Member.Name.Substring(1) : node.Member.Name
                               )
                            )
                        );
                    }
                }
                /*
                    Example - "me" is a field:

                    var me = await client.Me.ExecuteAsync();
            
                    var filesQuery = await client.Users.Where(i => i.UserPrincipalName != me.UserPrincipalName).ExecuteAsync();
                */
                else if (node.Member is System.Reflection.FieldInfo) // for local variables
                {
                    var fieldTypeInfo = System.Reflection.IntrospectionExtensions.GetTypeInfo(((System.Reflection.FieldInfo)node.Member).FieldType);
                    if (System.Linq.Enumerable.Any<System.Reflection.CustomAttributeData>(fieldTypeInfo.CustomAttributes, i => i.AttributeType == typeof(LowerCasePropertyAttribute)))
                    {
                        var expression = System.Linq.Expressions.Expression.TypeAs(node, CreateConcreteType(fieldTypeInfo.AsType()));
                        return expression;
                    }
                }

                return base.VisitMember(node);
            }
        }

        private System.Linq.Expressions.ExpressionVisitor _pascalCaseExpressionVisitor = new PascalCaseExpressionVisitor();

        public IReadOnlyQueryableSet<TResult> Select<TResult>(System.Linq.Expressions.Expression<System.Func<TSource, TResult>> selector)
        {
            var newSelector = _pascalCaseExpressionVisitor.Visit(selector);

            DataServiceQuery query = CallLinqMethod(newSelector);

            return new ReadOnlyQueryableSet<TResult>(
                query,
                _context);
        }

        public IReadOnlyQueryableSet<TSource> Where(System.Linq.Expressions.Expression<System.Func<TSource, bool>> predicate)
        {
            // Fix for DevDiv 941323:
            if (predicate.Body.NodeType == System.Linq.Expressions.ExpressionType.Coalesce)
            {
                var binary = (System.Linq.Expressions.BinaryExpression)predicate.Body;

                var constantRight = binary.Right as System.Linq.Expressions.ConstantExpression;

                // If we are coalescing bool to false, it is a no-op
                if (constantRight != null &&
                    constantRight.Value is bool &&
                    !(bool)constantRight.Value &&
                    binary.Left.Type == typeof(bool?) &&
                    binary.Left is System.Linq.Expressions.BinaryExpression)
                {
                    var oldLeft = (System.Linq.Expressions.BinaryExpression)binary.Left;

                    var newLeft = System.Linq.Expressions.Expression.MakeBinary(
                        oldLeft.NodeType,
                        oldLeft.Left,
                        oldLeft.Right);

                    predicate = (System.Linq.Expressions.Expression<System.Func<TSource, bool>>)System.Linq.Expressions.Expression.Lambda(
                        predicate.Type,
                        newLeft,
                        predicate.TailCall,
                        predicate.Parameters);
                }
            }

            var newSelector = _pascalCaseExpressionVisitor.Visit(predicate);

            DataServiceQuery query = CallLinqMethod(newSelector, true);

            return new ReadOnlyQueryableSet<TSource>(
                query,
                _context);
        }

        public IReadOnlyQueryableSet<TResult> OfType<TResult>()
        {
            DataServiceQuery query = ApplyLinq(new[] { typeof(TResult) }, new object[] { _inner }) ??
                (DataServiceQuery)System.Linq.Queryable.OfType<TResult>((System.Linq.IQueryable<TSource>)_inner);

            return new ReadOnlyQueryableSet<TResult>(
                query,
                _context);
        }

        public IReadOnlyQueryableSet<TSource> Skip(int count)
        {
            DataServiceQuery query = ApplyLinq(new[] { typeof(TSource) }, new object[] { _inner, count }) ??
                (DataServiceQuery)System.Linq.Queryable.Skip<TSource>((System.Linq.IQueryable<TSource>)_inner, count);

            return new ReadOnlyQueryableSet<TSource>(
                query,
                _context);
        }

        public IReadOnlyQueryableSet<TSource> Take(int count)
        {
            DataServiceQuery query = ApplyLinq(new[] { typeof(TSource) }, new object[] { _inner, count }) ??
                (DataServiceQuery)System.Linq.Queryable.Take<TSource>((System.Linq.IQueryable<TSource>)_inner, count);

            return new ReadOnlyQueryableSet<TSource>(
                query,
                _context);
        }

        public IReadOnlyQueryableSet<TSource> OrderBy<TKey>(System.Linq.Expressions.Expression<System.Func<TSource, TKey>> keySelector)
        {
            var newSelector = _pascalCaseExpressionVisitor.Visit(keySelector);

            DataServiceQuery query = CallLinqMethod(newSelector);

            return new ReadOnlyQueryableSet<TSource>(
                query,
                _context);
        }

        public IReadOnlyQueryableSet<TSource> OrderByDescending<TKey>(System.Linq.Expressions.Expression<System.Func<TSource, TKey>> keySelector)
        {
            var newSelector = _pascalCaseExpressionVisitor.Visit(keySelector);

            DataServiceQuery query = CallLinqMethod(newSelector);

            return new ReadOnlyQueryableSet<TSource>(
                query,
                _context);
        }

        public IReadOnlyQueryableSet<TSource> Expand<TTarget>(System.Linq.Expressions.Expression<Func<TSource, TTarget>> navigationPropertyAccessor)
        {
            var newSelector = _pascalCaseExpressionVisitor.Visit(navigationPropertyAccessor);

            var concreteType = _concreteType.Value ?? typeof(TSource);
            var concreteDsq = typeof(DataServiceQuery<>).MakeGenericType(concreteType);

            DataServiceQuery query = CallOnConcreteType(concreteDsq, _inner, new[] { typeof(TTarget) }, new object[] { newSelector });

            return new ReadOnlyQueryableSet<TSource>(
                query,
                _context);
        }

        private DataServiceQuery ApplyLinq(Type[] typeParams, object[] callParams, [System.Runtime.CompilerServices.CallerMemberName] string methodName = null)
        {
            return CallOnConcreteType(typeof(System.Linq.Queryable), null, typeParams, callParams, methodName);
        }

        private DataServiceQuery CallOnConcreteType(Type targetType, object instance, Type[] typeParams, object[] callParams, [System.Runtime.CompilerServices.CallerMemberName] string methodName = null)
        {
            for (int i = 0; i < typeParams.Length; i++)
            {
                if (typeParams[i] == typeof(TSource))
                {
                    typeParams[i] = _concreteType.Value;
                }
                else
                {
                    var concreteType = CreateConcreteType(typeParams[i]);

                    if (concreteType != null)
                    {
                        typeParams[i] = concreteType;
                    }
                }
            }

            var typeInfo = System.Reflection.IntrospectionExtensions.GetTypeInfo(targetType);
            var methodInfo =
                (from i in typeInfo.GetDeclaredMethods(methodName)
                 let parameters = i.GetParameters()
                 where i.GetGenericArguments().Length == typeParams.Length
                 let constructedMethod = i.MakeGenericMethod(typeParams)
                 where AllParametersAreAssignable(constructedMethod.GetParameters(), callParams)
                 select constructedMethod).First();

            return (DataServiceQuery)methodInfo.Invoke(instance, callParams);
        }

        private bool AllParametersAreAssignable(System.Reflection.ParameterInfo[] parameterInfo, object[] callParams)
        {
            for (int i = 0; i < parameterInfo.Length; i++)
            {
                if (callParams[i] != null &&
                    !System.Reflection.IntrospectionExtensions.GetTypeInfo(parameterInfo[i].ParameterType).IsAssignableFrom(
                    System.Reflection.IntrospectionExtensions.GetTypeInfo(callParams[i].GetType())))
                {
                    return false;
                }
            }

            return true;
        }

        private DataServiceQuery CallLinqMethod(
            System.Linq.Expressions.Expression predicate,
            bool singleGenericParameter = false,
            [System.Runtime.CompilerServices.CallerMemberName] string methodName = null)
        {
            System.Type[] typeParams = singleGenericParameter ?
                new Type[] { predicate.Type.GenericTypeArguments[0] } :
                predicate.Type.GenericTypeArguments;

            var callParams = new object[] { _inner, predicate };

            var typeInfo = System.Reflection.IntrospectionExtensions.GetTypeInfo(typeof(System.Linq.Queryable));
            var methodInfo =
                (from i in typeInfo.GetDeclaredMethods(methodName)
                 let parameters = i.GetParameters()
                 where i.GetGenericArguments().Length == typeParams.Length
                 let constructedMethod = i.MakeGenericMethod(typeParams)
                 where AllParametersAreAssignable(constructedMethod.GetParameters(), callParams)
                 select constructedMethod).First();

            return (DataServiceQuery)methodInfo.Invoke(null, callParams);
        }
        #endregion
    }

    public interface IPagedCollection<TElement>
    {
        global::System.Collections.Generic.IReadOnlyList<TElement> CurrentPage { get; }
        bool MorePagesAvailable { get; }
        global::System.Threading.Tasks.Task<IPagedCollection<TElement>> GetNextPageAsync();
    }

    public interface IPagedCollection
    {
        global::System.Collections.Generic.IReadOnlyList<object> CurrentPage { get; }
        bool MorePagesAvailable { get; }
        global::System.Threading.Tasks.Task<IPagedCollection> GetNextPageAsync();
    }

    internal class PagedCollection<TElement, TConcrete> : IPagedCollection, IPagedCollection<TElement> where TConcrete : TElement
    {
        private DataServiceContextWrapper _context;
        private DataServiceQueryContinuation<TConcrete> _continuation;
        private IReadOnlyList<TElement> _currentPage;

        // Creator - should be faster than Activator.CreateInstance
        public static PagedCollection<TElement, TConcrete> Create(DataServiceContextWrapper context,
            QueryOperationResponse<TConcrete> qor)
        {
            return new PagedCollection<TElement, TConcrete>(context, qor);
        }

        internal PagedCollection(DataServiceContextWrapper context,
            QueryOperationResponse<TConcrete> qor)
        {
            _context = context;
            _currentPage = (IReadOnlyList<TElement>)qor.ToList();
            _continuation = qor.GetContinuation();
        }

        public PagedCollection(DataServiceContextWrapper context, DataServiceCollection<TConcrete> collection)
        {
            _context = context;
            _currentPage = (IReadOnlyList<TElement>)collection;
            if (_currentPage != null)
            {
                _continuation = collection.Continuation;
            }
        }

        public bool MorePagesAvailable
        {
            get
            {
                return _continuation != null;
            }
        }

        public System.Collections.Generic.IReadOnlyList<TElement> CurrentPage
        {
            get
            {
                return _currentPage;
            }
        }

        public async System.Threading.Tasks.Task<IPagedCollection<TElement>> GetNextPageAsync()
        {
            if (_continuation != null)
            {
                var task = _context.ExecuteAsync<TConcrete, TElement>(_continuation);

                return new PagedCollection<TElement, TConcrete>(_context, await task);
            }

            return (IPagedCollection<TElement>)null;
        }

        IReadOnlyList<object> IPagedCollection.CurrentPage
        {
            get { return (IReadOnlyList<object>)this.CurrentPage; }
        }

        async System.Threading.Tasks.Task<IPagedCollection> IPagedCollection.GetNextPageAsync()
        {
            var retval = await GetNextPageAsync();

            return (PagedCollection<TElement, TConcrete>)retval;
        }
    }

    public interface IStreamFetcher
    {
        string ContentType { get; }
        global::System.Threading.Tasks.Task<global::Microsoft.OData.Client.DataServiceStreamResponse> DownloadAsync();
        global::System.Threading.Tasks.Task UploadAsync(global::System.IO.Stream stream, string contentType, bool dontSave = false, bool closeStream = false);
    }

    internal class StreamFetcher : IStreamFetcher
    {
        private global::Microsoft.OData.Client.DataServiceStreamLink _link;
        private EntityBase _entity;
        private string _propertyName;
        private DataServiceContextWrapper _context;

        public string ContentType
        {
            get
            {
                return _link.ContentType;
            }
        }

        internal StreamFetcher(DataServiceContextWrapper context, EntityBase entity, string propertyName, global::Microsoft.OData.Client.DataServiceStreamLink link)
        {
            _context = context;
            _entity = entity;
            _link = link;
            _propertyName = propertyName;
        }

        public global::System.Threading.Tasks.Task UploadAsync(global::System.IO.Stream stream, string contentType, bool dontSave = false, bool closeStream = false)
        {
            var args = new global::Microsoft.OData.Client.DataServiceRequestArgs
            {
                ContentType = contentType
            };

            if (_link.ETag != null)
            {
                args.Headers.Add("If-Match", _link.ETag);
            }

            _context.SetSaveStream(_entity, _propertyName, stream, closeStream, args);

            _entity.OnPropertyChanged(_propertyName);

            return _entity.SaveAsNeeded(dontSave);
        }

        public global::System.Threading.Tasks.Task<global::Microsoft.OData.Client.DataServiceStreamResponse> DownloadAsync()
        {
            return _context.GetReadStreamAsync(_entity, _propertyName, ContentType);
        }
    }
}
namespace ODataV4TestClient
{
    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface IContainer
    {
        global::ODataV4TestClient.IProductCollection Products
        {
            get;
        }

        global::ODataV4TestClient.ISuppliedProductCollection SuppliedProducts
        {
            get;
        }

        global::ODataV4TestClient.ISupplierCollection Suppliers
        {
            get;
        }

        global::ODataV4TestClient.IProductCollection OtherProducts
        {
            get;
        }

        global::ODataV4TestClient.IAccountCollection Accounts
        {
            get;
        }
    }

    public partial class Container : IContainer
    {
        private const string _path = "";

        public ODataV4TestClient.Extensions.DataServiceContextWrapper Context
        {
            get;
            private set;
        }

        internal ODataV4TestClient.Extensions.DataServiceContextWrapper GetContext()
        {
            return Context;
        }

        private string GetPath(string propertyName)
        {
            return propertyName == null ? _path : _path + "/" + propertyName;
        }

        public Container(global::System.Uri serviceRoot, global::System.Func<global::System.Threading.Tasks.Task<string>> accessTokenGetter)
        {
            Context = new ODataV4TestClient.Extensions.DataServiceContextWrapper(serviceRoot, global::Microsoft.OData.Client.ODataProtocolVersion.V4, accessTokenGetter);
            Context.MergeOption = global::Microsoft.OData.Client.MergeOption.OverwriteChanges;

            Context.ResolveName = new global::System.Func<global::System.Type, string>(this.ResolveNameFromType);
            Context.ResolveType = new global::System.Func<string, global::System.Type>(this.ResolveTypeFromName);
            this.OnContextCreated();
            Context.Format.LoadServiceModel = GeneratedEdmModel.GetInstance;
            Context.Format.UseJson();
        }
        partial void OnContextCreated();
        /// <summary>
        /// Since the namespace configured for this service reference
        /// in Visual Studio is different from the one indicated in the
        /// server schema, use type-mappers to map between the two.
        /// </summary>
        private global::System.Type ResolveTypeFromName(string typeName)
        {
            global::System.Type resolvedType = Context.DefaultResolveTypeInternal(typeName, "ODataV4TestService.Models", "ODataV4TestClient");
            if ((resolvedType != null))
            {
                return resolvedType;
            }
            return null;
        }
        /// <summary>
        /// Since the namespace configured for this service reference
        /// in Visual Studio is different from the one indicated in the
        /// server schema, use type-mappers to map between the two.
        /// </summary>
        private string ResolveNameFromType(global::System.Type clientType)
        {
            if (clientType.Namespace.Equals("ODataV4TestClient", global::System.StringComparison.Ordinal))
            {
                return string.Concat("ODataV4TestService.Models.", clientType.Name);
            }
            return clientType.FullName;
        }

        // tag0003
        public IProductCollection Products
        {
            get
            {
                if ((_Products == null))
                {
                    _Products = new ProductCollection(
                        Context != null ? Context.CreateQuery<Product>(GetPath("Products")) : null,
                        Context,
                        this,
                        GetPath("Products"));
                }

                return _Products;
            }
        }

        private IProductCollection _Products;

        // tag0003
        public ISuppliedProductCollection SuppliedProducts
        {
            get
            {
                if ((_SuppliedProducts == null))
                {
                    _SuppliedProducts = new SuppliedProductCollection(
                        Context != null ? Context.CreateQuery<SuppliedProduct>(GetPath("SuppliedProducts")) : null,
                        Context,
                        this,
                        GetPath("SuppliedProducts"));
                }

                return _SuppliedProducts;
            }
        }

        private ISuppliedProductCollection _SuppliedProducts;

        // tag0003
        public ISupplierCollection Suppliers
        {
            get
            {
                if ((_Suppliers == null))
                {
                    _Suppliers = new SupplierCollection(
                        Context != null ? Context.CreateQuery<Supplier>(GetPath("Suppliers")) : null,
                        Context,
                        this,
                        GetPath("Suppliers"));
                }

                return _Suppliers;
            }
        }

        private ISupplierCollection _Suppliers;

        // tag0003
        public IProductCollection OtherProducts
        {
            get
            {
                if ((_OtherProducts == null))
                {
                    _OtherProducts = new ProductCollection(
                        Context != null ? Context.CreateQuery<Product>(GetPath("OtherProducts")) : null,
                        Context,
                        this,
                        GetPath("OtherProducts"));
                }

                return _OtherProducts;
            }
        }

        private IProductCollection _OtherProducts;

        // tag0003
        public IAccountCollection Accounts
        {
            get
            {
                if ((_Accounts == null))
                {
                    _Accounts = new AccountCollection(
                        Context != null ? Context.CreateQuery<Account>(GetPath("Accounts")) : null,
                        Context,
                        this,
                        GetPath("Accounts"));
                }

                return _Accounts;
            }
        }

        private IAccountCollection _Accounts;
        /// <summary>
        /// There are no comments for Products in the schema.
        /// </summary>
        public void AddToProducts(Product product)
        {
            Context.AddObject("Products", product);
        }
        /// <summary>
        /// There are no comments for SuppliedProducts in the schema.
        /// </summary>
        public void AddToSuppliedProducts(SuppliedProduct suppliedProduct)
        {
            Context.AddObject("SuppliedProducts", suppliedProduct);
        }
        /// <summary>
        /// There are no comments for Suppliers in the schema.
        /// </summary>
        public void AddToSuppliers(Supplier supplier)
        {
            Context.AddObject("Suppliers", supplier);
        }
        /// <summary>
        /// There are no comments for OtherProducts in the schema.
        /// </summary>
        public void AddToOtherProducts(Product product)
        {
            Context.AddObject("OtherProducts", product);
        }
        /// <summary>
        /// There are no comments for Accounts in the schema.
        /// </summary>
        public void AddToAccounts(Account account)
        {
            Context.AddObject("Accounts", account);
        }

        private abstract class GeneratedEdmModel
        {
            private static global::Microsoft.OData.Edm.IEdmModel s_ParsedModel = LoadModelFromString();

            private const string Edmx = @"<edmx:Edmx Version=""4.0"" xmlns:edmx=""http://docs.oasis-open.org/odata/ns/edmx"">
  <edmx:DataServices>
    <Schema Namespace=""ODataV4TestService.Models"" xmlns=""http://docs.oasis-open.org/odata/ns/edm"">
      <EntityType Name=""Product"">
        <Key>
          <PropertyRef Name=""Id"" />
        </Key>
        <Property Name=""Id"" Type=""Edm.Int32"" Nullable=""false"" />
        <Property Name=""Name"" Type=""Edm.String"" />
        <Property Name=""Price"" Type=""Edm.Decimal"" Nullable=""false"" />
        <Property Name=""Category"" Type=""Edm.String"" />
      </EntityType>
      <EntityType Name=""SuppliedProduct"" BaseType=""ODataV4TestService.Models.Product"">
        <Property Name=""SupplierId"" Type=""Edm.Int32"" />
        <NavigationProperty Name=""Supplier"" Type=""ODataV4TestService.Models.Supplier"" />
      </EntityType>
      <EntityType Name=""Supplier"">
        <Key>
          <PropertyRef Name=""Id"" />
        </Key>
        <Property Name=""Id"" Type=""Edm.Int32"" Nullable=""false"" />
        <Property Name=""Name"" Type=""Edm.String"" />
        <NavigationProperty Name=""Products"" Type=""Collection(ODataV4TestService.Models.SuppliedProduct)"" />
      </EntityType>
      <EntityType Name=""Account"">
        <Key>
          <PropertyRef Name=""AccountId"" />
        </Key>
        <Property Name=""AccountId"" Type=""Edm.Int32"" Nullable=""false"" />
        <Property Name=""Name"" Type=""Edm.String"" />
        <NavigationProperty Name=""PayinPIs"" Type=""Collection(ODataV4TestService.Models.PaymentInstrument)"" ContainsTarget=""true"" />
      </EntityType>
      <EntityType Name=""PaymentInstrument"">
        <Key>
          <PropertyRef Name=""PaymentInstrumentId"" />
        </Key>
        <Property Name=""PaymentInstrumentId"" Type=""Edm.Int32"" Nullable=""false"" />
        <Property Name=""FriendlyName"" Type=""Edm.String"" />
      </EntityType>
      <Action Name=""Rate"" IsBound=""true"">
        <Parameter Name=""bindingParameter"" Type=""ODataV4TestService.Models.Product"" />
        <Parameter Name=""Rating"" Type=""Edm.Int32"" Nullable=""false"" />
      </Action>
      <Function Name=""Best"" IsBound=""true"">
        <Parameter Name=""bindingParameter"" Type=""Collection(ODataV4TestService.Models.Product)"" />
        <ReturnType Type=""Collection(ODataV4TestService.Models.Product)"" />
      </Function>
      <Function Name=""RelatedProducts"" IsBound=""true"">
        <Parameter Name=""product"" Type=""ODataV4TestService.Models.Product"" />
        <Parameter Name=""start"" Type=""Edm.DateTimeOffset"" Nullable=""false"" />
        <Parameter Name=""end"" Type=""Edm.DateTimeOffset"" Nullable=""false"" />
        <ReturnType Type=""Collection(ODataV4TestService.Models.Product)"" />
      </Function>
      <Function Name=""GetCount"" IsBound=""true"">
        <Parameter Name=""bindingParameter"" Type=""Collection(ODataV4TestService.Models.PaymentInstrument)"" />
        <Parameter Name=""NameContains"" Type=""Edm.String"" Unicode=""false"" />
        <ReturnType Type=""Edm.Int32"" Nullable=""false"" />
      </Function>
      <EntityContainer Name=""Container"">
        <EntitySet Name=""Products"" EntityType=""ODataV4TestService.Models.Product"">
          <NavigationPropertyBinding Path=""ODataV4TestService.Models.SuppliedProduct/Supplier"" Target=""Suppliers"" />
        </EntitySet>
        <EntitySet Name=""SuppliedProducts"" EntityType=""ODataV4TestService.Models.SuppliedProduct"">
          <NavigationPropertyBinding Path=""Supplier"" Target=""Suppliers"" />
        </EntitySet>
        <EntitySet Name=""Suppliers"" EntityType=""ODataV4TestService.Models.Supplier"">
          <NavigationPropertyBinding Path=""Products"" Target=""SuppliedProducts"" />
        </EntitySet>
        <EntitySet Name=""OtherProducts"" EntityType=""ODataV4TestService.Models.Product"">
          <NavigationPropertyBinding Path=""ODataV4TestService.Models.SuppliedProduct/Supplier"" Target=""Suppliers"" />
        </EntitySet>
        <EntitySet Name=""Accounts"" EntityType=""ODataV4TestService.Models.Account"" />
      </EntityContainer>
    </Schema>
  </edmx:DataServices>
</edmx:Edmx>";

            public static global::Microsoft.OData.Edm.IEdmModel GetInstance()
            {
                return s_ParsedModel;
            }

            private static global::Microsoft.OData.Edm.IEdmModel LoadModelFromString()
            {
                global::System.Xml.XmlReader reader = CreateXmlReader(Edmx);
                try
                {
                    return global::Microsoft.OData.Edm.Csdl.EdmxReader.Parse(reader);
                }
                finally
                {
                    ((global::System.IDisposable)(reader)).Dispose();
                }
            }

            private static global::System.Xml.XmlReader CreateXmlReader(string edmxToParse)
            {
                return global::System.Xml.XmlReader.Create(new global::System.IO.StringReader(edmxToParse));
            }
        }
    }
    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface IProductFetcher
    {
        new global::System.Threading.Tasks.Task<IProduct> ExecuteAsync();

        new IProductFetcher Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<IProduct, TTarget>> navigationPropertyAccessor);


        ISuppliedProductFetcher ToSuppliedProduct();
        // tag0009
        global::System.Threading.Tasks.Task RateAsync(int Rating);
        // tag0009
        global::System.Threading.Tasks.Task<global::System.Collections.Generic.IEnumerable<global::ODataV4TestClient.IProduct>> RelatedProductsAsync(global::System.DateTimeOffset start, global::System.DateTimeOffset end);
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface IProduct : ODataV4TestClient.Extensions.IEntityBase
    {
        int Id
        {
            get; set;
        }
        string Name
        {
            get; set;
        }
        decimal Price
        {
            get; set;
        }
        string Category
        {
            get; set;
        }
        // tag0009
        global::System.Threading.Tasks.Task RateAsync(int Rating);
        // tag0009
        global::System.Threading.Tasks.Task<global::System.Collections.Generic.IEnumerable<global::ODataV4TestClient.IProduct>> RelatedProductsAsync(global::System.DateTimeOffset start, global::System.DateTimeOffset end);
    }

    internal partial class ProductFetcher : ODataV4TestClient.Extensions.RestShallowObjectFetcher, IProductFetcher
    {
        public ISuppliedProductFetcher ToSuppliedProduct()
        {
            var retVal = new SuppliedProductFetcher();
            retVal.Initialize(Context, GetPath(null));
            return retVal;
        }


        public async global::System.Threading.Tasks.Task<IProduct> ExecuteAsync()
        {
            return await EnsureQuery().ExecuteSingleAsync();
        }

        public IProductFetcher Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<IProduct, TTarget>> navigationPropertyAccessor)
        {
            return new ProductFetcher
            {
                _query = EnsureQuery().Expand(navigationPropertyAccessor)
            };
        }

        private IReadOnlyQueryableSet<IProduct> EnsureQuery()
        {
            if (_query == null)
            {
                _query = new global::ODataV4TestClient.Extensions.ReadOnlyQueryableSet<IProduct>(Context.CreateQuery<Product>(GetPath(null)), Context);
            }

            return _query;
        }

        private global::ODataV4TestClient.Extensions.IReadOnlyQueryableSet<IProduct> _query;

        // tag0005
        /// <summary>
        /// There are no comments for RelatedProducts in the schema.
        /// </summary>
        public async global::System.Threading.Tasks.Task<global::System.Collections.Generic.IEnumerable<global::ODataV4TestClient.IProduct>> RelatedProductsAsync(global::System.DateTimeOffset start, global::System.DateTimeOffset end)
        {
            var myUri = GetUrl();
            if (myUri == null)
            {
                throw new global::System.Exception("cannot find entity");
            }

            global::System.Uri requestUriTmp = new global::System.Uri(myUri + "/" + "ODataV4TestService.Models.RelatedProducts" + "(" + "start=" + "@start" + ", " + "end=" + "@end" + ")" + "?" + "@start=" + global::Microsoft.OData.Core.UriParser.ODataUriUtils.ConvertToUriLiteral(start, ODataVersion.V4) + "&@end=" + global::Microsoft.OData.Core.UriParser.ODataUriUtils.ConvertToUriLiteral(end, ODataVersion.V4));
            return await Context.ExecuteAsync<global::ODataV4TestClient.IProduct>(requestUriTmp, "GET", false);
        }
        /// <summary>
        /// There are no comments for Rate in the schema.
        /// </summary>
        public async global::System.Threading.Tasks.Task RateAsync(int Rating)
        {
            var myUri = GetUrl();
            if (myUri == null)
            {
                throw new global::System.Exception("cannot find entity");
            }

            global::System.Uri requestUri = new global::System.Uri(myUri.ToString().TrimEnd('/') + "/" + "Rate");
            await Context.ExecuteAsync(requestUri, "POST",
                new global::Microsoft.OData.Client.OperationParameter[] { new global::Microsoft.OData.Client.BodyOperationParameter("Rating", Rating) });
        }
    }

    [global::Microsoft.OData.Client.Key("Id")]
    public partial class Product : global::ODataV4TestClient.Extensions.EntityBase, IProduct, IProductFetcher
    {
        public Product() : base()
        {
        }
        // tag0002

        public int Id
        {
            get
            {
                return _Id;
            }
            set
            {
                if (_Id != value)
                {
                    _Id = value;
                    OnPropertyChanged("Id");
                }
            }
        }

        private int _Id;


        // tag0002

        public string Name
        {
            get
            {
                return _Name;
            }
            set
            {
                if (_Name != value)
                {
                    _Name = value;
                    OnPropertyChanged("Name");
                }
            }
        }

        private string _Name;


        // tag0002

        public decimal Price
        {
            get
            {
                return _Price;
            }
            set
            {
                if (_Price != value)
                {
                    _Price = value;
                    OnPropertyChanged("Price");
                }
            }
        }

        private decimal _Price;


        // tag0002

        public string Category
        {
            get
            {
                return _Category;
            }
            set
            {
                if (_Category != value)
                {
                    _Category = value;
                    OnPropertyChanged("Category");
                }
            }
        }

        private string _Category;


        // tag0005
        /// <summary>
        /// There are no comments for RelatedProducts in the schema.
        /// </summary>
        public async global::System.Threading.Tasks.Task<global::System.Collections.Generic.IEnumerable<global::ODataV4TestClient.IProduct>> RelatedProductsAsync(global::System.DateTimeOffset start, global::System.DateTimeOffset end)
        {
            var myUri = GetUrl();
            if (myUri == null)
            {
                throw new global::System.Exception("cannot find entity");
            }

            global::System.Uri requestUriTmp = new global::System.Uri(myUri + "/" + "ODataV4TestService.Models.RelatedProducts" + "(" + "start=" + "@start" + ", " + "end=" + "@end" + ")" + "?" + "@start=" + global::Microsoft.OData.Core.UriParser.ODataUriUtils.ConvertToUriLiteral(start, ODataVersion.V4) + "&@end=" + global::Microsoft.OData.Core.UriParser.ODataUriUtils.ConvertToUriLiteral(end, ODataVersion.V4));
            return await Context.ExecuteAsync<global::ODataV4TestClient.IProduct>(requestUriTmp, "GET", false);
        }
        /// <summary>
        /// There are no comments for Rate in the schema.
        /// </summary>
        public async global::System.Threading.Tasks.Task RateAsync(int Rating)
        {
            var myUri = GetUrl();
            if (myUri == null)
            {
                throw new global::System.Exception("cannot find entity");
            }

            global::System.Uri requestUri = new global::System.Uri(myUri.ToString().TrimEnd('/') + "/" + "Rate");
            await Context.ExecuteAsync(requestUri, "POST",
                new global::Microsoft.OData.Client.OperationParameter[] { new global::Microsoft.OData.Client.BodyOperationParameter("Rating", Rating) });
        }

        global::System.Threading.Tasks.Task<IProduct> IProductFetcher.ExecuteAsync()
        {
            var tsc = new global::System.Threading.Tasks.TaskCompletionSource<IProduct>();
            tsc.SetResult(this);
            return tsc.Task;
        }

        IProductFetcher IProductFetcher.Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<IProduct, TTarget>> navigationPropertyAccessor)
        {
            return this;
        }
        ISuppliedProductFetcher IProductFetcher.ToSuppliedProduct()
        {
            return (ISuppliedProductFetcher)this;
        }
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface ISuppliedProductFetcher : IProductFetcher
    {
        new global::System.Threading.Tasks.Task<ISuppliedProduct> ExecuteAsync();

        new ISuppliedProductFetcher Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<ISuppliedProduct, TTarget>> navigationPropertyAccessor);

        global::ODataV4TestClient.ISupplierFetcher Supplier
        {
            get;
        }
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface ISuppliedProduct : IProduct
    {
        global::System.Nullable<int> SupplierId
        {
            get; set;
        }
        global::ODataV4TestClient.ISupplier Supplier
        {
            get; set;
        }
    }

    internal partial class SuppliedProductFetcher : ProductFetcher, ISuppliedProductFetcher
    {
        // tag 0004
        public global::ODataV4TestClient.ISupplierFetcher Supplier
        {
            get
            {
                if ((_Supplier == null))
                {
                    _Supplier = new global::ODataV4TestClient.SupplierFetcher();
                    _Supplier.Initialize(this.Context, GetPath("Supplier"));
                }
                return _Supplier;
            }
        }

        private global::ODataV4TestClient.SupplierFetcher _Supplier;

        public new async global::System.Threading.Tasks.Task<ISuppliedProduct> ExecuteAsync()
        {
            return await EnsureQuery().ExecuteSingleAsync();
        }

        public new ISuppliedProductFetcher Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<ISuppliedProduct, TTarget>> navigationPropertyAccessor)
        {
            return new SuppliedProductFetcher
            {
                _query = EnsureQuery().Expand(navigationPropertyAccessor)
            };
        }

        private IReadOnlyQueryableSet<ISuppliedProduct> EnsureQuery()
        {
            if (_query == null)
            {
                _query = new global::ODataV4TestClient.Extensions.ReadOnlyQueryableSet<ISuppliedProduct>(Context.CreateQuery<SuppliedProduct>(GetPath(null)), Context);
            }

            return _query;
        }

        private global::ODataV4TestClient.Extensions.IReadOnlyQueryableSet<ISuppliedProduct> _query;
    }

    [global::Microsoft.OData.Client.Key("Id")]
    public partial class SuppliedProduct : Product, ISuppliedProduct, ISuppliedProductFetcher
    {
        public SuppliedProduct() : base()
        {
        }
        // tag0002

        public global::System.Nullable<int> SupplierId
        {
            get
            {
                return _SupplierId;
            }
            set
            {
                if (_SupplierId != value)
                {
                    _SupplierId = value;
                    OnPropertyChanged("SupplierId");
                }
            }
        }

        private global::System.Nullable<int> _SupplierId;


        // tag 0012
        global::ODataV4TestClient.ISupplier ODataV4TestClient.ISuppliedProduct.Supplier
        {
            get
            {
                return this.Supplier;
            }
            set
            {
                if (this.Supplier != value)
                {
                    this.Supplier = (global::ODataV4TestClient.Supplier)value;
                }
            }
        }

        global::ODataV4TestClient.ISupplierFetcher ODataV4TestClient.ISuppliedProductFetcher.Supplier
        {
            get
            {
                var retVal = new global::ODataV4TestClient.SupplierFetcher();
                retVal.Initialize(this.Context, GetPath("Supplier"));
                return retVal;
            }
        }

        // tag0015
        public global::ODataV4TestClient.Supplier Supplier
        {
            get
            {
                return _Supplier;
            }
            set
            {
                if (_Supplier != value)
                {
                    _Supplier = value;
                    if (Context != null && Context.GetEntityDescriptor(this) != null && (value == null || Context.GetEntityDescriptor(value) != null))
                    {
                        Context.SetLink(this, "Supplier", value);
                    }
                }
            }
        }

        private global::ODataV4TestClient.Supplier _Supplier;

        global::System.Threading.Tasks.Task<ISuppliedProduct> ISuppliedProductFetcher.ExecuteAsync()
        {
            var tsc = new global::System.Threading.Tasks.TaskCompletionSource<ISuppliedProduct>();
            tsc.SetResult(this);
            return tsc.Task;
        }

        ISuppliedProductFetcher ISuppliedProductFetcher.Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<ISuppliedProduct, TTarget>> navigationPropertyAccessor)
        {
            return this;
        }
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface ISupplierFetcher
    {
        new global::System.Threading.Tasks.Task<ISupplier> ExecuteAsync();

        new ISupplierFetcher Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<ISupplier, TTarget>> navigationPropertyAccessor);

        global::ODataV4TestClient.ISuppliedProductCollection Products
        {
            get;
        }
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface ISupplier : ODataV4TestClient.Extensions.IEntityBase
    {
        int Id
        {
            get; set;
        }
        string Name
        {
            get; set;
        }
        ODataV4TestClient.Extensions.IPagedCollection<global::ODataV4TestClient.ISuppliedProduct> Products
        {
            get;
        }
    }

    internal partial class SupplierFetcher : ODataV4TestClient.Extensions.RestShallowObjectFetcher, ISupplierFetcher
    {
        // tag0003
        public global::ODataV4TestClient.ISuppliedProductCollection Products
        {
            get
            {
                if ((_Products == null))
                {
                    _Products = new global::ODataV4TestClient.SuppliedProductCollection(
                        Context != null ? Context.CreateQuery<global::ODataV4TestClient.SuppliedProduct>(GetPath("Products")) : null,
                        Context,
                        this,
                        GetPath("Products"));
                }

                return _Products;
            }
        }

        private global::ODataV4TestClient.ISuppliedProductCollection _Products;

        public async global::System.Threading.Tasks.Task<ISupplier> ExecuteAsync()
        {
            return await EnsureQuery().ExecuteSingleAsync();
        }

        public ISupplierFetcher Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<ISupplier, TTarget>> navigationPropertyAccessor)
        {
            return new SupplierFetcher
            {
                _query = EnsureQuery().Expand(navigationPropertyAccessor)
            };
        }

        private IReadOnlyQueryableSet<ISupplier> EnsureQuery()
        {
            if (_query == null)
            {
                _query = new global::ODataV4TestClient.Extensions.ReadOnlyQueryableSet<ISupplier>(Context.CreateQuery<Supplier>(GetPath(null)), Context);
            }

            return _query;
        }

        private global::ODataV4TestClient.Extensions.IReadOnlyQueryableSet<ISupplier> _query;
    }

    [global::Microsoft.OData.Client.Key("Id")]
    public partial class Supplier : global::ODataV4TestClient.Extensions.EntityBase, ISupplier, ISupplierFetcher
    {
        public Supplier() : base()
        {
        }
        // tag0002

        public int Id
        {
            get
            {
                return _Id;
            }
            set
            {
                if (_Id != value)
                {
                    _Id = value;
                    OnPropertyChanged("Id");
                }
            }
        }

        private int _Id;


        // tag0002

        public string Name
        {
            get
            {
                return _Name;
            }
            set
            {
                if (_Name != value)
                {
                    _Name = value;
                    OnPropertyChanged("Name");
                }
            }
        }

        private string _Name;


        // tag 0014
        global::ODataV4TestClient.ISuppliedProductCollection ODataV4TestClient.ISupplierFetcher.Products
        {
            get
            {
                if (_ProductsFetcher == null)
                {
                    _ProductsFetcher = new global::ODataV4TestClient.SuppliedProductCollection(
                        Context != null ? Context.CreateQuery<global::ODataV4TestClient.SuppliedProduct>(GetPath("Products")) : null,
                        Context,
                        this,
                        GetPath("Products"));
                }

                return _ProductsFetcher;
            }
        }
        private global::ODataV4TestClient.ISuppliedProductCollection _ProductsFetcher;


        // tag0013
        public global::System.Collections.Generic.IList<global::ODataV4TestClient.SuppliedProduct> Products
        {
            get
            {
                if (_Products == null)
                {
                    _Products = new EntityCollectionImpl<global::ODataV4TestClient.SuppliedProduct>();
                    _Products.SetContainer(() => GetContainingEntity("Products"));
                }

                return _Products;
            }
            set
            {
                Products.Clear();
                if (value != null)
                {
                    foreach (var i in value)
                    {
                        Products.Add(i);
                    }
                }
            }
        }

        ODataV4TestClient.Extensions.IPagedCollection<global::ODataV4TestClient.ISuppliedProduct> ODataV4TestClient.ISupplier.Products
        {
            get
            {
                return new ODataV4TestClient.Extensions.PagedCollection<global::ODataV4TestClient.ISuppliedProduct, global::ODataV4TestClient.SuppliedProduct>(Context, (EntityCollectionImpl<global::ODataV4TestClient.SuppliedProduct>)Products);
            }
        }

        private EntityCollectionImpl<global::ODataV4TestClient.SuppliedProduct> _Products;

        global::System.Threading.Tasks.Task<ISupplier> ISupplierFetcher.ExecuteAsync()
        {
            var tsc = new global::System.Threading.Tasks.TaskCompletionSource<ISupplier>();
            tsc.SetResult(this);
            return tsc.Task;
        }

        ISupplierFetcher ISupplierFetcher.Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<ISupplier, TTarget>> navigationPropertyAccessor)
        {
            return this;
        }
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface IAccountFetcher
    {
        new global::System.Threading.Tasks.Task<IAccount> ExecuteAsync();

        new IAccountFetcher Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<IAccount, TTarget>> navigationPropertyAccessor);

        global::ODataV4TestClient.IPaymentInstrumentCollection PayinPIs
        {
            get;
        }
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface IAccount : ODataV4TestClient.Extensions.IEntityBase
    {
        int AccountId
        {
            get; set;
        }
        string Name
        {
            get; set;
        }
        ODataV4TestClient.Extensions.IPagedCollection<global::ODataV4TestClient.IPaymentInstrument> PayinPIs
        {
            get;
        }
    }

    internal partial class AccountFetcher : ODataV4TestClient.Extensions.RestShallowObjectFetcher, IAccountFetcher
    {
        // tag0003
        public global::ODataV4TestClient.IPaymentInstrumentCollection PayinPIs
        {
            get
            {
                if ((_PayinPIs == null))
                {
                    _PayinPIs = new global::ODataV4TestClient.PaymentInstrumentCollection(
                        Context != null ? Context.CreateQuery<global::ODataV4TestClient.PaymentInstrument>(GetPath("PayinPIs")) : null,
                        Context,
                        this,
                        GetPath("PayinPIs"));
                }

                return _PayinPIs;
            }
        }

        private global::ODataV4TestClient.IPaymentInstrumentCollection _PayinPIs;

        public async global::System.Threading.Tasks.Task<IAccount> ExecuteAsync()
        {
            return await EnsureQuery().ExecuteSingleAsync();
        }

        public IAccountFetcher Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<IAccount, TTarget>> navigationPropertyAccessor)
        {
            return new AccountFetcher
            {
                _query = EnsureQuery().Expand(navigationPropertyAccessor)
            };
        }

        private IReadOnlyQueryableSet<IAccount> EnsureQuery()
        {
            if (_query == null)
            {
                _query = new global::ODataV4TestClient.Extensions.ReadOnlyQueryableSet<IAccount>(Context.CreateQuery<Account>(GetPath(null)), Context);
            }

            return _query;
        }

        private global::ODataV4TestClient.Extensions.IReadOnlyQueryableSet<IAccount> _query;
    }

    [global::Microsoft.OData.Client.Key("AccountId")]
    public partial class Account : global::ODataV4TestClient.Extensions.EntityBase, IAccount, IAccountFetcher
    {
        public Account() : base()
        {
        }
        // tag0002

        public int AccountId
        {
            get
            {
                return _AccountId;
            }
            set
            {
                if (_AccountId != value)
                {
                    _AccountId = value;
                    OnPropertyChanged("AccountId");
                }
            }
        }

        private int _AccountId;


        // tag0002

        public string Name
        {
            get
            {
                return _Name;
            }
            set
            {
                if (_Name != value)
                {
                    _Name = value;
                    OnPropertyChanged("Name");
                }
            }
        }

        private string _Name;


        // tag 0014
        global::ODataV4TestClient.IPaymentInstrumentCollection ODataV4TestClient.IAccountFetcher.PayinPIs
        {
            get
            {
                if (_PayinPIsFetcher == null)
                {
                    _PayinPIsFetcher = new global::ODataV4TestClient.PaymentInstrumentCollection(
                        Context != null ? Context.CreateQuery<global::ODataV4TestClient.PaymentInstrument>(GetPath("PayinPIs")) : null,
                        Context,
                        this,
                        GetPath("PayinPIs"));
                }

                return _PayinPIsFetcher;
            }
        }
        private global::ODataV4TestClient.IPaymentInstrumentCollection _PayinPIsFetcher;


        // tag0013
        public global::System.Collections.Generic.IList<global::ODataV4TestClient.PaymentInstrument> PayinPIs
        {
            get
            {
                if (_PayinPIs == null)
                {
                    _PayinPIs = new EntityCollectionImpl<global::ODataV4TestClient.PaymentInstrument>();
                    _PayinPIs.SetContainer(() => GetContainingEntity("PayinPIs"));
                }

                return _PayinPIs;
            }
            set
            {
                PayinPIs.Clear();
                if (value != null)
                {
                    foreach (var i in value)
                    {
                        PayinPIs.Add(i);
                    }
                }
            }
        }

        ODataV4TestClient.Extensions.IPagedCollection<global::ODataV4TestClient.IPaymentInstrument> ODataV4TestClient.IAccount.PayinPIs
        {
            get
            {
                return new ODataV4TestClient.Extensions.PagedCollection<global::ODataV4TestClient.IPaymentInstrument, global::ODataV4TestClient.PaymentInstrument>(Context, (EntityCollectionImpl<global::ODataV4TestClient.PaymentInstrument>)PayinPIs);
            }
        }

        private EntityCollectionImpl<global::ODataV4TestClient.PaymentInstrument> _PayinPIs;

        global::System.Threading.Tasks.Task<IAccount> IAccountFetcher.ExecuteAsync()
        {
            var tsc = new global::System.Threading.Tasks.TaskCompletionSource<IAccount>();
            tsc.SetResult(this);
            return tsc.Task;
        }

        IAccountFetcher IAccountFetcher.Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<IAccount, TTarget>> navigationPropertyAccessor)
        {
            return this;
        }
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface IPaymentInstrumentFetcher
    {
        new global::System.Threading.Tasks.Task<IPaymentInstrument> ExecuteAsync();

        new IPaymentInstrumentFetcher Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<IPaymentInstrument, TTarget>> navigationPropertyAccessor);
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface IPaymentInstrument : ODataV4TestClient.Extensions.IEntityBase
    {
        int PaymentInstrumentId
        {
            get; set;
        }
        string FriendlyName
        {
            get; set;
        }
    }

    internal partial class PaymentInstrumentFetcher : ODataV4TestClient.Extensions.RestShallowObjectFetcher, IPaymentInstrumentFetcher
    {
        public async global::System.Threading.Tasks.Task<IPaymentInstrument> ExecuteAsync()
        {
            return await EnsureQuery().ExecuteSingleAsync();
        }

        public IPaymentInstrumentFetcher Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<IPaymentInstrument, TTarget>> navigationPropertyAccessor)
        {
            return new PaymentInstrumentFetcher
            {
                _query = EnsureQuery().Expand(navigationPropertyAccessor)
            };
        }

        private IReadOnlyQueryableSet<IPaymentInstrument> EnsureQuery()
        {
            if (_query == null)
            {
                _query = new global::ODataV4TestClient.Extensions.ReadOnlyQueryableSet<IPaymentInstrument>(Context.CreateQuery<PaymentInstrument>(GetPath(null)), Context);
            }

            return _query;
        }

        private global::ODataV4TestClient.Extensions.IReadOnlyQueryableSet<IPaymentInstrument> _query;
    }

    [global::Microsoft.OData.Client.Key("PaymentInstrumentId")]
    public partial class PaymentInstrument : global::ODataV4TestClient.Extensions.EntityBase, IPaymentInstrument, IPaymentInstrumentFetcher
    {
        public PaymentInstrument() : base()
        {
        }
        // tag0002

        public int PaymentInstrumentId
        {
            get
            {
                return _PaymentInstrumentId;
            }
            set
            {
                if (_PaymentInstrumentId != value)
                {
                    _PaymentInstrumentId = value;
                    OnPropertyChanged("PaymentInstrumentId");
                }
            }
        }

        private int _PaymentInstrumentId;


        // tag0002

        public string FriendlyName
        {
            get
            {
                return _FriendlyName;
            }
            set
            {
                if (_FriendlyName != value)
                {
                    _FriendlyName = value;
                    OnPropertyChanged("FriendlyName");
                }
            }
        }

        private string _FriendlyName;



        global::System.Threading.Tasks.Task<IPaymentInstrument> IPaymentInstrumentFetcher.ExecuteAsync()
        {
            var tsc = new global::System.Threading.Tasks.TaskCompletionSource<IPaymentInstrument>();
            tsc.SetResult(this);
            return tsc.Task;
        }

        IPaymentInstrumentFetcher IPaymentInstrumentFetcher.Expand<TTarget>(System.Linq.Expressions.Expression<global::System.Func<IPaymentInstrument, TTarget>> navigationPropertyAccessor)
        {
            return this;
        }
    }

    internal partial class ProductCollection : ODataV4TestClient.Extensions.QueryableSet<IProduct>, IProductCollection
    {
        internal ProductCollection(
            global::Microsoft.OData.Client.DataServiceQuery inner,
            ODataV4TestClient.Extensions.DataServiceContextWrapper context,
            object entity,
            string path)
            : base(inner, context, entity as EntityBase, path)
        {
        }

        public IProductFetcher GetById(int id)
        {
            return this[id];
        }

        public IProductFetcher this[int id]
        {
            get
            {
                var query = (global::Microsoft.OData.Client.DataServiceQuery)System.Linq.Queryable.Where(Context.CreateQuery<Product>(this._path), (i) => i.Id == id);
                var fetcher = new ProductFetcher();
                var path = query.RequestUri.ToString().Substring(Context.BaseUri.ToString().TrimEnd('/').Length + 1);
                fetcher.Initialize(Context, path);

                return fetcher;
            }
        }

        public global::System.Threading.Tasks.Task<IPagedCollection<IProduct>> ExecuteAsync()
        {
            return base.ExecuteAsyncInternal();
        }

        public global::System.Threading.Tasks.Task AddProductAsync(IProduct item, bool dontSave = false)
        {
            if (_entity == null)
            {
                Context.AddObject(_path, item);
            }
            else
            {
                var lastSlash = _path.LastIndexOf('/');
                var shortPath = (lastSlash >= 0 && lastSlash < _path.Length - 1) ? _path.Substring(lastSlash + 1) : _path;
                Context.AddRelatedObject(_entity, shortPath, item);
            }

            if (!dontSave)
            {
                return Context.SaveChangesAsync();
            }
            else
            {
                var retVal = new global::System.Threading.Tasks.TaskCompletionSource<object>();
                retVal.SetResult(null);
                return retVal.Task;
            }
        }
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface IProductCollection : IReadOnlyQueryableSetBase<IProduct>
    {
        IProductFetcher GetById(int id);

        IProductFetcher this[int id]
        {
            get;
        }

        global::System.Threading.Tasks.Task<IPagedCollection<IProduct>> ExecuteAsync();

        global::System.Threading.Tasks.Task AddProductAsync(IProduct item, bool dontSave = false);
    }

    internal partial class SuppliedProductCollection : ODataV4TestClient.Extensions.QueryableSet<ISuppliedProduct>, ISuppliedProductCollection
    {
        internal SuppliedProductCollection(
            global::Microsoft.OData.Client.DataServiceQuery inner,
            ODataV4TestClient.Extensions.DataServiceContextWrapper context,
            object entity,
            string path)
            : base(inner, context, entity as EntityBase, path)
        {
        }

        public ISuppliedProductFetcher GetById(int id)
        {
            return this[id];
        }

        public ISuppliedProductFetcher this[int id]
        {
            get
            {
                var query = (global::Microsoft.OData.Client.DataServiceQuery)System.Linq.Queryable.Where(Context.CreateQuery<SuppliedProduct>(this._path), (i) => i.Id == id);
                var fetcher = new SuppliedProductFetcher();
                var path = query.RequestUri.ToString().Substring(Context.BaseUri.ToString().TrimEnd('/').Length + 1);
                fetcher.Initialize(Context, path);

                return fetcher;
            }
        }

        public global::System.Threading.Tasks.Task<IPagedCollection<ISuppliedProduct>> ExecuteAsync()
        {
            return base.ExecuteAsyncInternal();
        }

        public global::System.Threading.Tasks.Task AddSuppliedProductAsync(ISuppliedProduct item, bool dontSave = false)
        {
            if (_entity == null)
            {
                Context.AddObject(_path, item);
            }
            else
            {
                var lastSlash = _path.LastIndexOf('/');
                var shortPath = (lastSlash >= 0 && lastSlash < _path.Length - 1) ? _path.Substring(lastSlash + 1) : _path;
                Context.AddRelatedObject(_entity, shortPath, item);
            }

            if (!dontSave)
            {
                return Context.SaveChangesAsync();
            }
            else
            {
                var retVal = new global::System.Threading.Tasks.TaskCompletionSource<object>();
                retVal.SetResult(null);
                return retVal.Task;
            }
        }
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface ISuppliedProductCollection : IReadOnlyQueryableSetBase<ISuppliedProduct>
    {
        ISuppliedProductFetcher GetById(int id);

        ISuppliedProductFetcher this[int id]
        {
            get;
        }

        global::System.Threading.Tasks.Task<IPagedCollection<ISuppliedProduct>> ExecuteAsync();

        global::System.Threading.Tasks.Task AddSuppliedProductAsync(ISuppliedProduct item, bool dontSave = false);
    }

    internal partial class SupplierCollection : ODataV4TestClient.Extensions.QueryableSet<ISupplier>, ISupplierCollection
    {
        internal SupplierCollection(
            global::Microsoft.OData.Client.DataServiceQuery inner,
            ODataV4TestClient.Extensions.DataServiceContextWrapper context,
            object entity,
            string path)
            : base(inner, context, entity as EntityBase, path)
        {
        }

        public ISupplierFetcher GetById(int id)
        {
            return this[id];
        }

        public ISupplierFetcher this[int id]
        {
            get
            {
                var query = (global::Microsoft.OData.Client.DataServiceQuery)System.Linq.Queryable.Where(Context.CreateQuery<Supplier>(this._path), (i) => i.Id == id);
                var fetcher = new SupplierFetcher();
                var path = query.RequestUri.ToString().Substring(Context.BaseUri.ToString().TrimEnd('/').Length + 1);
                fetcher.Initialize(Context, path);

                return fetcher;
            }
        }

        public global::System.Threading.Tasks.Task<IPagedCollection<ISupplier>> ExecuteAsync()
        {
            return base.ExecuteAsyncInternal();
        }

        public global::System.Threading.Tasks.Task AddSupplierAsync(ISupplier item, bool dontSave = false)
        {
            if (_entity == null)
            {
                Context.AddObject(_path, item);
            }
            else
            {
                var lastSlash = _path.LastIndexOf('/');
                var shortPath = (lastSlash >= 0 && lastSlash < _path.Length - 1) ? _path.Substring(lastSlash + 1) : _path;
                Context.AddRelatedObject(_entity, shortPath, item);
            }

            if (!dontSave)
            {
                return Context.SaveChangesAsync();
            }
            else
            {
                var retVal = new global::System.Threading.Tasks.TaskCompletionSource<object>();
                retVal.SetResult(null);
                return retVal.Task;
            }
        }
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface ISupplierCollection : IReadOnlyQueryableSetBase<ISupplier>
    {
        ISupplierFetcher GetById(int id);

        ISupplierFetcher this[int id]
        {
            get;
        }

        global::System.Threading.Tasks.Task<IPagedCollection<ISupplier>> ExecuteAsync();

        global::System.Threading.Tasks.Task AddSupplierAsync(ISupplier item, bool dontSave = false);
    }

    internal partial class AccountCollection : ODataV4TestClient.Extensions.QueryableSet<IAccount>, IAccountCollection
    {
        internal AccountCollection(
            global::Microsoft.OData.Client.DataServiceQuery inner,
            ODataV4TestClient.Extensions.DataServiceContextWrapper context,
            object entity,
            string path)
            : base(inner, context, entity as EntityBase, path)
        {
        }

        public IAccountFetcher GetByAccountId(int accountId)
        {
            return this[accountId];
        }

        public IAccountFetcher this[int accountId]
        {
            get
            {
                var query = (global::Microsoft.OData.Client.DataServiceQuery)System.Linq.Queryable.Where(Context.CreateQuery<Account>(this._path), (i) => i.AccountId == accountId);
                var fetcher = new AccountFetcher();
                var path = query.RequestUri.ToString().Substring(Context.BaseUri.ToString().TrimEnd('/').Length + 1);
                fetcher.Initialize(Context, path);

                return fetcher;
            }
        }

        public global::System.Threading.Tasks.Task<IPagedCollection<IAccount>> ExecuteAsync()
        {
            return base.ExecuteAsyncInternal();
        }

        public global::System.Threading.Tasks.Task AddAccountAsync(IAccount item, bool dontSave = false)
        {
            if (_entity == null)
            {
                Context.AddObject(_path, item);
            }
            else
            {
                var lastSlash = _path.LastIndexOf('/');
                var shortPath = (lastSlash >= 0 && lastSlash < _path.Length - 1) ? _path.Substring(lastSlash + 1) : _path;
                Context.AddRelatedObject(_entity, shortPath, item);
            }

            if (!dontSave)
            {
                return Context.SaveChangesAsync();
            }
            else
            {
                var retVal = new global::System.Threading.Tasks.TaskCompletionSource<object>();
                retVal.SetResult(null);
                return retVal.Task;
            }
        }
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface IAccountCollection : IReadOnlyQueryableSetBase<IAccount>
    {
        IAccountFetcher GetByAccountId(int accountId);

        IAccountFetcher this[int accountId]
        {
            get;
        }

        global::System.Threading.Tasks.Task<IPagedCollection<IAccount>> ExecuteAsync();

        global::System.Threading.Tasks.Task AddAccountAsync(IAccount item, bool dontSave = false);
    }

    internal partial class PaymentInstrumentCollection : ODataV4TestClient.Extensions.QueryableSet<IPaymentInstrument>, IPaymentInstrumentCollection
    {
        internal PaymentInstrumentCollection(
            global::Microsoft.OData.Client.DataServiceQuery inner,
            ODataV4TestClient.Extensions.DataServiceContextWrapper context,
            object entity,
            string path)
            : base(inner, context, entity as EntityBase, path)
        {
        }

        public IPaymentInstrumentFetcher GetByPaymentInstrumentId(int paymentInstrumentId)
        {
            return this[paymentInstrumentId];
        }

        public IPaymentInstrumentFetcher this[int paymentInstrumentId]
        {
            get
            {
                var query = (global::Microsoft.OData.Client.DataServiceQuery)System.Linq.Queryable.Where(Context.CreateQuery<PaymentInstrument>(this._path), (i) => i.PaymentInstrumentId == paymentInstrumentId);
                var fetcher = new PaymentInstrumentFetcher();
                var path = query.RequestUri.ToString().Substring(Context.BaseUri.ToString().TrimEnd('/').Length + 1);
                fetcher.Initialize(Context, path);

                return fetcher;
            }
        }

        public global::System.Threading.Tasks.Task<IPagedCollection<IPaymentInstrument>> ExecuteAsync()
        {
            return base.ExecuteAsyncInternal();
        }

        public global::System.Threading.Tasks.Task AddPaymentInstrumentAsync(IPaymentInstrument item, bool dontSave = false)
        {
            if (_entity == null)
            {
                Context.AddObject(_path, item);
            }
            else
            {
                var lastSlash = _path.LastIndexOf('/');
                var shortPath = (lastSlash >= 0 && lastSlash < _path.Length - 1) ? _path.Substring(lastSlash + 1) : _path;
                Context.AddRelatedObject(_entity, shortPath, item);
            }

            if (!dontSave)
            {
                return Context.SaveChangesAsync();
            }
            else
            {
                var retVal = new global::System.Threading.Tasks.TaskCompletionSource<object>();
                retVal.SetResult(null);
                return retVal.Task;
            }
        }
    }

    [ODataV4TestClient.Extensions.LowerCaseProperty]
    public partial interface IPaymentInstrumentCollection : IReadOnlyQueryableSetBase<IPaymentInstrument>
    {
        IPaymentInstrumentFetcher GetByPaymentInstrumentId(int paymentInstrumentId);

        IPaymentInstrumentFetcher this[int paymentInstrumentId]
        {
            get;
        }

        global::System.Threading.Tasks.Task<IPagedCollection<IPaymentInstrument>> ExecuteAsync();

        global::System.Threading.Tasks.Task AddPaymentInstrumentAsync(IPaymentInstrument item, bool dontSave = false);
    }
}





